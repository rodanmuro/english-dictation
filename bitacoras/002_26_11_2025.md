# Bitácora 002 - 26/11/2025

## Phase 2: Backend Services (Steps 2.1 & 2.2) - IN PROGRESS ⏳

### Objective
Implement the configuration system and video utilities for the English Dictation App backend.

---

## Work Completed

### 1. Configuration System (`app/config.py`)

**Created:** Application configuration settings using Pydantic Settings

**Features:**
- Environment variable loading from `.env` file
- Type-safe configuration with Pydantic validation
- Case-insensitive environment variables

**Settings Defined:**
- `deepgram_api_key` (str) - Deepgram API key for transcription
- `audio_dir` (str) - Directory path for audio files (default: `app/static/audios`)
- `app_name` (str) - Application name (default: "English Dictation App")
- `debug` (bool) - Debug mode flag (default: False)

**Usage:**
```python
from app.config import settings

api_key = settings.deepgram_api_key
audio_path = settings.audio_dir
```

**Key Benefits:**
- Centralized configuration management
- Type validation at runtime
- Easy to extend with new settings
- Automatic .env file loading

---

### 2. Video Utilities (`app/utils/video_utils.py`)

**Created:** YouTube URL parsing and validation utilities

**Functions Implemented:**

#### `extract_video_id(youtube_url: str) -> str`
Extracts video ID from various YouTube URL formats.

**Supported URL Formats:**
- `https://www.youtube.com/watch?v=VIDEO_ID`
- `https://www.youtube.com/watch?v=VIDEO_ID&feature=share`
- `https://youtu.be/VIDEO_ID`
- `https://youtu.be/VIDEO_ID?t=123`
- `https://www.youtube.com/embed/VIDEO_ID`
- `https://www.youtube.com/v/VIDEO_ID`

**Error Handling:**
- Raises `ValueError` for invalid URLs
- Clear error messages indicating supported formats

#### `validate_youtube_url(youtube_url: str) -> bool`
Validates if a URL is a valid YouTube URL.

**Returns:**
- `True` if valid YouTube URL
- `False` if invalid

---

### 3. Testing Infrastructure

**Created:** Test suite for video utilities

**Test File:** `tests/test_video_utils.py`

**Test Coverage:**

1. **Valid URL Extraction (9 test cases)**
   - Standard youtube.com/watch format
   - Short youtu.be format
   - Embed format
   - /v/ format
   - URLs with additional parameters
   - HTTP and HTTPS variants

2. **Invalid URL Handling (5 test cases)**
   - Non-YouTube URLs (Google, Vimeo)
   - Invalid strings
   - Empty strings
   - YouTube URL without video ID
   - Proper ValueError raising

3. **URL Validation (5 test cases)**
   - Valid YouTube URLs return True
   - Invalid URLs return False

**Test Results:** ✅ 19/19 tests passed (100%)

**Test Execution:**
```bash
python -m tests.test_video_utils
```

---

### 4. Project Organization

**Created:** `tests/` directory for test organization
- Moved test file to `tests/test_video_utils.py`
- Added `tests/__init__.py` for proper Python package structure
- Organized testing infrastructure

**Structure:**
```
tests/
├── __init__.py
└── test_video_utils.py
```

---

## Technical Details

### YouTube URL Parsing Implementation

**Approach:**
- Used `urllib.parse` for standard URL parsing
- Regular expressions for pattern matching
- Multiple pattern checks for different URL formats
- Clean error handling with descriptive messages

**Example:**
```python
from app.utils.video_utils import extract_video_id

# All these return "7obx1BmOp3M"
extract_video_id("https://www.youtube.com/watch?v=7obx1BmOp3M")
extract_video_id("https://youtu.be/7obx1BmOp3M")
extract_video_id("https://www.youtube.com/embed/7obx1BmOp3M")
```

### Configuration System Implementation

**Approach:**
- Used `pydantic-settings` for type-safe configuration
- Automatic environment variable loading
- Validation on application startup
- Global settings instance for easy access

**Example:**
```python
from app.config import settings

# Settings loaded from .env file
print(settings.deepgram_api_key)  # Type-safe access
print(settings.audio_dir)          # Default values supported
```

---

## Files Created/Modified

**New Files:**
- `app/config.py` - Configuration settings (28 lines)
- `app/utils/video_utils.py` - Video utilities (87 lines)
- `tests/__init__.py` - Tests package initialization
- `tests/test_video_utils.py` - Video utils test suite (167 lines)

**Total Lines of Code:** ~282 lines

---

## Next Steps

**Remaining Phase 2 Tasks:**

1. **Step 2.3:** YouTube Service (`services/youtube_service.py`)
   - Download audio from YouTube using yt-dlp
   - MP3 conversion
   - Check if already downloaded (caching)

2. **Step 2.4:** Deepgram Service (`services/deepgram_service.py`)
   - Generate SRT files using Deepgram API
   - Use ResponseWrapper pattern
   - Check if already generated (caching)

3. **Step 2.5:** SRT Parser (`services/srt_parser.py`)
   - Parse SRT file format
   - Convert timestamps to seconds
   - Return JSON array of segments

4. **Step 2.6:** Cache Service (`services/cache_service.py`)
   - Read/write cache.json
   - Store video processing status
   - Manage segments data

**Estimated Time Remaining:** 1.5-2 hours

---

## Status

✅ **Phase 2.1: Config - COMPLETED**
✅ **Phase 2.2: Video Utils - COMPLETED**
✅ **Testing: Video Utils - COMPLETED (19/19 tests passing)**
⏳ **Phase 2.3: YouTube Service - PENDING**
⏳ **Phase 2.4: Deepgram Service - PENDING**
⏳ **Phase 2.5: SRT Parser - PENDING**
⏳ **Phase 2.6: Cache Service - PENDING**

---

## Notes

- All video URL formats commonly used are now supported
- Test-driven approach ensures reliability
- Configuration system is extensible for future settings
- Error handling provides clear feedback to users
- Code is well-documented with docstrings and examples